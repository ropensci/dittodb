<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developing `dittodb` • dittodb</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Developing `dittodb`">
<meta name="robots" content="noindex">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-150741105-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-150741105-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dittodb</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.8.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dittodb.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/dittodb.html">Getting Started with dittodb</a></li>
    <li><a class="dropdown-item" href="../articles/nycflights.html">nycflights data</a></li>
    <li><a class="dropdown-item" href="../articles/developing-dittodb.html">Developing dittodb</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://jonkeane.com/blog/introducing_dittodb/">Version 1.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/dittodb/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Developing `dittodb`</h1>
                        <h4 data-toc-skip class="author">Jonathan
Keane</h4>
            
            <h4 data-toc-skip class="date">2025-08-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/dittodb/blob/main/vignettes/developing-dittodb.Rmd" class="external-link"><code>vignettes/developing-dittodb.Rmd</code></a></small>
      <div class="d-none name"><code>developing-dittodb.Rmd</code></div>
    </div>

    
    
<p>We welcome contributions from anyone, no matter how small or trivial.
Documentation additions or typo fixes are especially welcome. For
larger, more-functional changes, either see if there is an issue open on
GitHub already, or open one with a proposal of the change you would like
to make. Please also see our <a href="../docs/CODE_OF_CONDUCT.html">code
of conduct</a> and <a href="../docs/CONTRIBUTING.html">contributing
guide</a>.</p>
<p>Developing <code>dittodb</code> requires is a bit more complication
than developing other R packages for a few reasons:</p>
<ol style="list-style-type: decimal">
<li>setting up all of the databases to fully test recording is
complicated (which is in some ways the exact reason <code>dittodb</code>
exists, so you don’t have to do this!)</li>
<li>some of the mechanisms that make <code>dittodb</code> work aren’t
commonly used in other R packages.</li>
</ol>
<div class="section level2">
<h2 id="setting-up-databases">Setting up databases<a class="anchor" aria-label="anchor" href="#setting-up-databases"></a>
</h2>
<p>In order to fully test that <code>dittodb</code> works, we aim to
have full coverage and test as many database backends as possible for
both recording and using as a mocked database. To do this on continuous
integration (CI for short) can be finicky to get working (and on the CI
front, we did it once, so that you can use <code>dittodb</code> and you
won’t have to setup your own database backend just to run tests!).
Frankly, even doing this set up locally on a second computer can be a
pain! We include in the repository a few scripts that make it
(relatively) easy to setup testing database backends, as well as some
scripts that we use to setup database backends on GitHub Actions.</p>
<div class="section level3">
<h3 id="what-we-test">What we test<a class="anchor" aria-label="anchor" href="#what-we-test"></a>
</h3>
<p>We currently test against the following database backends with GitHub
Actions for CI:</p>
<ul>
<li>Postgres (with drivers: <a href="https://CRAN.R-project.org/package=RPostgres" class="external-link">RPostgres</a>, <a href="https://CRAN.R-project.org/package=RPostgreSQL" class="external-link">RPostgreSQL</a>,
and <a href="https://CRAN.R-project.org/package=odbc" class="external-link">odbc</a>)</li>
<li>MariaDB (with driver: <a href="https://CRAN.R-project.org/package=RMariaDB" class="external-link">RMariaDB</a>)</li>
<li>SQLite (with driver: <a href="https://CRAN.R-project.org/package=RSQLite" class="external-link">RSQLite</a>)</li>
</ul>
</div>
<div class="section level3">
<h3 id="how-to-setup-test-databases-locally">How to setup test databases locally<a class="anchor" aria-label="anchor" href="#how-to-setup-test-databases-locally"></a>
</h3>
<p>All of these (with the exception of SQLite) are tested in the test
file <code>test-dbi-generic-integration.R</code>. However, tests for
each database are only run if specific environment variables are set
that trigger them. The reason for this is so that it is easy to test
locally without needing to setup databases, but we are covered by these
tests being run on GitHub Actions. If you would like to run these tests
locally, you can set the following environment variables and run tests
as usual (e.g. with <code>R CMD check</code>,
<code>devtools::check()</code>, <code>devtools::test()</code>)</p>
<ul>
<li>if <code>DITTODB_ENABLE_PG_TESTS</code> is <code>TRUE</code>, then
Postgres-based tests will be run</li>
<li>if <code>DITTODB_ENABLE_MARIA_TESTS</code> is <code>TRUE</code>,
then MariaDB-based tests will be run</li>
</ul>
<p>There are a few scripts included in the <code>db-setup</code> folder
that are helpful for setting up databases. For local tests, we highly
recommend using the docker scripts:</p>
<ul>
<li>
<code>db-setup/local-mariadb-docker-setup.sh</code> which starts (or
stops and then starts if it’s already running) a docker container,
installs MariaDB in that container (running on the default port 3306),
and loads the correct test user and test data into the database for
running tests.</li>
<li>
<code>db-setup/local-postgres-docker-setup.sh</code> which starts
(or stops and then starts if it’s already running) a docker container,
installs Postgres in that container (running on the default port 5432),
and loads the correct test user and test data into the database for
running tests.</li>
</ul>
<p>If you’ve already got databases running on the default ports (3306
for MariaDB and 5432 for Postgres) and you want to use the docker
scripts, we recommend that you change the ports that docker is using for
any databases you’re already running. You can use the
<code>DITTODB_MARIA_TEST_PORT</code> and
<code>DITTODB_PG_TEST_PORT</code> environment variables to change which
port <code>dittodb</code> uses to connect to the test databases. The
docker scripts above will use these environment variables to map ports
if they are set (and exported) for convenience. One thing to note:
during <code>dittodb</code> tests, if some database drivers attempt to
connect to not-running or on-the-wrong-port database backends, they can
segfault instead of erroring with a more informative error. If you see
this, the first thing to check is that the port variables are being set
correctly and that the database backend is up and running normally.</p>
<p>Both of these utilize a few SQL (Structured Query Language) scripts
for their respective backends. These might be useful if you’re manually
adding the test data into a database you already have running, but if
you’re using the docker scripts above, you shouldn’t need to use them at
all.</p>
<ul>
<li>
<code>db-setup/[mariadb|postgres]-reset.sql</code> creates the
database <code>nycflights</code> and test users (dropping them if they
already exist so they are fresh).</li>
<li>
<code>db-setup/[mariadb|postgres]-nycflights.sql</code> creates the
necessary tables in the <code>nycflights</code> database for use in
testing.</li>
<li>
<code>db-setup/populate-dbs.sh</code> uses the above scripts to
populate the databases on GitHub Actions.</li>
</ul>
</div>
<div class="section level3">
<h3 id="what-not-to-run">☠️ What not to run ☠️<a class="anchor" aria-label="anchor" href="#what-not-to-run"></a>
</h3>
<p>The other scripts
(e.g. <code>db-setup/[mariadb|postgres]-brew.sh</code> and
<code>db-setup/[mariadb|postgres]-docker-container-only.sh</code>) are
only intended for use on GitHub Actions and should not be run locally.
They include commands that will remove files necessary to reset database
setups that allow for tests to be run. Running them locally will delete
files that you might care about.</p>
</div>
</div>
<div class="section level2">
<h2 id="some-of-the-tricky-bits-that-dittodb-uses">Some of the tricky bits that <code>dittodb</code> uses<a class="anchor" aria-label="anchor" href="#some-of-the-tricky-bits-that-dittodb-uses"></a>
</h2>
<p>In order to provide a seamless experience between using a real
database connection and using the mocked version of the database
<code>dittodb</code> uses some features of R that are pretty uncommon.
This is not intended to be a comprehensive description of
<code>dittodb</code>’s architecture, but a few things that are uncommon
or a little strange.</p>
<div class="section level3">
<h3 id="recording">Recording<a class="anchor" aria-label="anchor" href="#recording"></a>
</h3>
<p>In order to record fixtures while using a real database connection,
we use <code><a href="https://rdrr.io/r/base/trace.html" class="external-link">base::trace()</a></code> to add code that inspects the queries
(to define unique hashes) and saves the results so that they can be used
later. This tracing only happens when using the
<code><a href="../reference/capture_requests.html">start_db_capturing()</a></code> functions and should generally not be
used during testing by packages that use <code>dittodb</code>. Rather,
this functionality should generally be used to see what interactions a
piece of code to be tested is having with a database and either use or
edit and use the fixtures it produces in testing.</p>
</div>
<div class="section level3">
<h3 id="using-a-mocked-database">Using a mocked database<a class="anchor" aria-label="anchor" href="#using-a-mocked-database"></a>
</h3>
<p>When using fixtures (i.e. with a mocked database), we use some
internals to mock the <code><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">DBI::dbConnect()</a></code> function and replace
the true connection with a special mock connection class from
<code>dittodb</code> (<code>DBIMockConnection</code>, though there are
specific sub-classes for some drivers,
e.g. <code>DBIMockRPostgresConnection</code>). Then <code>dittodb</code>
relies on standard S4 method dispatch to find the appropriate fixture
for queries being run during testing.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://jonkeane.com/" class="external-link">Jonathan Keane</a>, <a href="https://pacha.dev/" class="external-link">Mauricio Vargas</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
